fileVersion: 1
id: "1"
macroString: |-
  {% set packageConfiguration = namespace(universalObjectDmfs=['FRESHNESS'], 
                                          nullCountUniversalColumns=[], 
                                          nullPercentUniversalColumns=[],
                                          blankCountUniversalColumns=[],
                                          blankPercentUniversalColumns=[],
                                          duplicateCountUniversalColumns=[],
                                          uniqueCountUniversalColumns=[],
                                          freshnessUniversalColumns=[]) %}

  {%- macro ref_raw(location_name, node_name) -%}
      {%- raw -%}{{ ref('{% endraw %}{{- location_name }}{% raw %}', '{% endraw %}{{ node_name }}{% raw %}') }}{% endraw %}
  {%- endmacro -%}

  {#-- The below block of code initialises variables in case of node typess using advance deployment strategy #}

  {% if desiredState %}
      {% set columns = desiredState.columns %}
      {% set storageLocations = desiredState.storageLocations %}
      {% set config = desiredState.config %}
      {% set sources = desiredState.sources %}
      {% set node = desiredState.node %}
      {% set parameters = desiredState.parameters %}
  {% endif %}


  {#-- This macro will frame the order by clause with the columns and sort order specified in config #}
  {#-- Input parmeters   - None #}
  {#-- Return            - Order by clause #}

  {%- macro sortorder_by_colv(return) -%}
      {%- set nsVariables = namespace(sortcolNames="") -%}
      {%if config.orderby %}
          {%- for i in config.orderbycolumn.get('items') -%}
              {%- set colName = i.sortColName.name -%}
              {%- set colOrder = i.sortOrder -%}
  	        {%- if loop.first -%}	      
  		        {%- set nsVariables.sortcolNames = '"' + colName + '"' + colOrder -%}	  
  	        {%- else -%}      
  		        {%- set nsVariables.sortcolNames = nsVariables.sortcolNames + ',' + '"' + colName + '"' + colOrder-%}	  
  	        {%- endif -%}
          {%- endfor -%}	
              {%- set nsVariables.sortcolNames = 'order by' + nsVariables.sortcolNames -%}
   
      {% endif %} 
      
      {{- nsVariables.sortcolNames -}}
   
  {%- endmacro -%}



  {#-- This macro will split the join clause into from and rest of the clauses like where,groupby,orderby ,qualify  #}
  {#-- Input parmeters   - joinclause #}
  {#-- Return            - from clause and other clauses #}


  {%- macro get_clause( joinclause , ret_clause ) -%}

              {% set join_clause = joinclause %}
              {% set has_where_clause = 'where'in join_clause %}
              {% set has_WHERE_clause = 'WHERE'in join_clause %}
              {% set has_order_clause = 'order by'in join_clause %}
              {% set has_ORDER_clause = 'ORDER BY'in join_clause %}
              {% set has_group_clause =  'group by'in join_clause %}
              {% set has_GROUP_clause = 'GROUP BY'in join_clause %}
              {% set has_qualify_clause =  'qualify'in join_clause %}
              {% set has_QUALIFY_clause = 'QUALIFY'in join_clause %}

             

              {% set clause='default' %}

              {% if has_where_clause %}

                  {% set keyword='where'%} 
                  {% set clause='where_clause' %}
    
              {% elif  has_WHERE_clause %}

                   {% set keyword='WHERE'%}
                   {% set clause='where_clause' %}
              {% endif %}

              {% if has_group_clause and clause != 'where_clause'  %}

                   {% set keyword='group by'%}
                   {% set clause='group_clause' %}
              
              {% elif  has_GROUP_clause and clause != 'where_clause' %}

                   {% set keyword='GROUP BY'%}
                   {% set clause='group_clause' %}

              {% endif %}
  			
              {% if has_qualify_clause and clause != 'where_clause' and clause != 'group_clause'  %}

                   {% set keyword='qualify'%}
                   {% set clause='qualify_clause' %}
              
              {% elif  has_QUALIFY_clause and clause != 'where_clause' and clause != 'group_clause'  %}

                   {% set keyword='QUALIFY'%}
                   {% set clause='qualify_clause' %}

              {% endif %}            

  			{% if has_order_clause and  clause != 'where_clause' and clause != 'group_clause' and clause != 'qualify_clause' %}

                   {% set keyword='order by'%}
                   {% set clause='order_clause' %}
              
              {% elif has_ORDER_clause and clause != 'where_clause' and clause != 'group_clause' and clause != 'qualify_clause' %}

                   {% set keyword='ORDER BY'%}
                   {% set clause='order_clause' %}

              {% endif %}



              {% if clause == 'where_clause' %}
                 {% set parts = join_clause.split(keyword) %}
                 {% set from_clause = parts[0] %}
                 {% set add_clause = 'AND' + join_clause.split(keyword)[1] %}

              {% elif clause == 'group_clause' %}

                 {% set parts = join_clause.split(keyword) %}
                 {% set from_clause = parts[0] %}
                 {% set add_clause = 'group by' + join_clause.split(keyword)[1] %}

              
              {% elif clause == 'qualify_clause' %}

                 {% set parts = join_clause.split(keyword) %}
                 {% set from_clause = parts[0] %}
                 {% set add_clause = 'qualify' + join_clause.split(keyword)[1] %}


              {% elif clause == 'order_clause' %}

                 {% set parts = join_clause.split(keyword) %}
                 {% set from_clause = parts[0] %}
                 {% set add_clause =  'order by' + join_clause.split(keyword)[1] %}
                 

              {% else %}

                 {% set from_clause = join_clause %}
                 {% set add_clause = '' %}

              {% endif %}
  			
  			{% if ret_clause == 'from' %}
  			   {{ from_clause }}
  			{% else %}
  			   {{ add_clause }}
  			{% endif %}
  			
  			
  {%- endmacro -%}

  {% macro icebergcoldatatype( coldatatype ) %}
     
      {% set nsVariables = namespace(ibcoldatatype="") %}
      {%if 'VARCHAR' in coldatatype %}
           {% set nsVariables.ibcoldatatype = 'STRING' %}
      {%elif 'TIMESTAMP' in coldatatype%}
           {% set nsVariables.ibcoldatatype = 'TIMESTAMP' %}
      {%elif 'TIME' in coldatatype%}
           {% set nsVariables.ibcoldatatype = 'TIME' %}
      {%else%}
            {% set nsVariables.ibcoldatatype = coldatatype %}
      {%endif%}
         
      {{ nsVariables.ibcoldatatype }}
   
  {% endmacro %}

  {# ==========================================================================--
    Builds email alert settings for DMF notifications.

    Behavior:
    - Runs only when emailAlertToggle is enabled
    - Uses config values when overrideEmailAlertToggle is true and values are provided
    - Falls back to workspace / environment parameters otherwise

    Expected parameters:
    - DMF_ALERT_INTEGRATION
    - DMF_ALERT_EMAIL
    - DMF_ALERT_WAREHOUSE
    - DMF_ALERT_SCHEDULE
  ==========================================================================---- #}
  {% macro buildEmailSettings(ns, fullyQualifiedBaseTableName, fullyQualifiedViewName) %}

      {% if config.emailAlertToggle %}
      
          {% set use_override = config.overrideEmailAlertToggle %}

          {% set ns.notfIntegrationName =
              (config.notfIntegrationName if use_override and config.notfIntegrationName | trim
                  else parameters.DMF_ALERT_INTEGRATION) %}

          {% set ns.emailList =
              (config.emailList if use_override and config.emailList | trim
                  else parameters.DMF_ALERT_EMAIL) %}

          {% set ns.emailSubject =
              (parameters.DMF_EMAIL_SUBJECT if parameters.DMF_EMAIL_SUBJECT is defined and parameters.DMF_EMAIL_SUBJECT | trim | length > 0 else 'Data Quality Notification: Metric Threshold Exceeded') %}

          {% if parameters.DMF_EMAIL_BODY is defined and parameters.DMF_EMAIL_BODY | trim | length > 0 %}
              {% set ns.emailBody = parameters.DMF_EMAIL_BODY %}
          {% else %}
               {% set ns.emailBody = 'A monitored data quality metric for ' ~ fullyQualifiedBaseTableName ~ ' has moved outside of its expected range. Please review the Data Quality Monitoring Results View - ' ~ fullyQualifiedViewName ~ ' for details.' %}
          {% endif %}

          {% set ns.alertWarehouse =
              (config.alertWarehouse if use_override and config.alertWarehouse | trim
                  else parameters.DMF_ALERT_WAREHOUSE) %}

          {% set ns.alertFrequency =
              (config.alertFrequency if use_override and config.alertFrequency | trim
                  else parameters.DMF_ALERT_SCHEDULE) %}

          {% if config.nullCntTrigger %}
              {% set ns.metricCondition = ns.metricCondition + ["(metric_name = 'NULL_COUNT' AND value > 0)"] %}
          {% endif %}

          {% if config.nullPrcntTrigger %}
              {% set ns.metricCondition = ns.metricCondition + [
                  "(metric_name = 'NULL_PERCENT' AND value > " ~ config.nullPrcntThreshold ~ ")"
              ] %}
          {% endif %}

          {% if config.blankCntTrigger %}
              {% set ns.metricCondition = ns.metricCondition + ["(metric_name = 'BLANK_COUNT' AND value > 0)"] %}
          {% endif %}

          {% if config.blankPrcntTrigger %}
              {% set ns.metricCondition = ns.metricCondition + [
                  "(metric_name = 'BLANK_PERCENT' AND value > " ~ config.blankPrcntThreshold ~ ")"
              ] %}
          {% endif %}

          {% if config.dupCntTrigger %}
              {% set ns.metricCondition = ns.metricCondition + ["(metric_name = 'DUPLICATE_COUNT' AND value > 0)"] %}
          {% endif %}

          {% if config.freshTrigger %}
              {% set ns.metricCondition = ns.metricCondition + [
                  "(metric_name = 'FRESHNESS' AND value > " ~ config.freshThreshold ~ " * 3600 )"
              ] %}
          {% endif %}
      {% endif %}

  {% endmacro %}

  {# ==========================================================================--
   Renders the argument list for a Data Metric Function (DMF).

   - Supports both column-only arguments and table-based arguments.
   - If `object` is provided and not '<>', arguments are wrapped as:
         TABLE ( <object> ( <col1>, <col2>, ... ) )
   - If `object` is empty or '<>', columns are rendered directly.
   - Ensures correct comma placement between argument groups.

   Input structure:
     elements = [
       { object: 'TABLE_NAME', cols: ['COL1', 'COL2'] },
       { object: '<>', cols: ['COL3'] }
     ]
  ==========================================================================---- #}
  {% macro renderCustomDMFArgs(elements) %}
      (
      {% for elem in elements %}
          {% set obj = elem.object.replace('<', '').replace('>', '') | trim %}

          {% if obj and obj != '<>' %}
              TABLE (
              {{ obj }}
              (
          {% endif %}

          {% for col in elem.cols %}
              {{ col.replace('<', '').replace('>', '') }}{% if not loop.last %}, {% endif %}
          {% endfor %}

          {% if obj and obj != '<>' %}
              )
              )
          {% endif %}

          {% if not loop.last %}, {% endif %}
      {% endfor %}
      )
  {% endmacro %}

  {#----------------------------------------------------------------------------------------
  Macro: ref_no_quotes

  Purpose: Resolves a ref()-style argument into a fully qualified database object name by mapping the location and node name using nodeMetadata.

  Arguments: arg - A string containing a reference in the format ref('LOCATION_NAME', 'NODE_NAME').

  Returns: A fully qualified object name in the format: "database"."schema".NODE_NAME based on the matching locationName in nodeMetadata.mapping.
  -----------------------------------------------------------------------------------#}
  {%- macro ref_no_quotes(arg) -%}

      {% set location_name = arg.split("'")[1] %}
      {% set node_name = arg.split("'")[3] %}

      {%- for storage in nodeMetadata.mapping -%}
          {%- if nodeMetadata.mapping[storage].locationName == location_name -%}
              {{- nodeMetadata.mapping[storage].database -}}.{{- nodeMetadata.mapping[storage].schema -}}.{{- node_name -}}
          {%- endif -%}
      {%- endfor -%}
  {%- endmacro -%}
name: macro
type: Macro
