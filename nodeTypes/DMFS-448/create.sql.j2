{#
    Copyright (c) 2023 Coalesce. All rights reserved.
This script and its associated documentation are confidential and proprietary to Coalesce.
Unauthorized reproduction, distribution, or disclosure of this material is strictly prohibited.
Coalesce permits you to copy and modify this script for the purposes of using with Coalesce but
does not permit copying or modification for any other purpose.  
#}
{# == Node Type Name           : DMFs == #}
{# == Node Type Description    : This node creates DMFs == #}
{# ================================================================================================#}

{#------ Build Dictionary of Package Object Level DMF -------#}

{% set universalObjectDMF = packageConfiguration.universalObjectDmfs
                            if packageConfiguration.universalObjectDmfs is defined
                            else [] %}

{#------ Build Dictionary of Package Column Level DMF -------#}

{% set universalCoulmnDMF = [
    { 'DMF': 'NULL_COUNT',      'COLUMNS': packageConfiguration.nullCountUniversalColumns      | default([]) },
    { 'DMF': 'NULL_PERCENT',    'COLUMNS': packageConfiguration.nullPercentUniversalColumns    | default([]) },
    { 'DMF': 'BLANK_COUNT',     'COLUMNS': packageConfiguration.blankCountUniversalColumns     | default([]) },
    { 'DMF': 'BLANK_PERCENT',   'COLUMNS': packageConfiguration.blankPercentUniversalColumns   | default([]) },
    { 'DMF': 'DUPLICATE_COUNT', 'COLUMNS': packageConfiguration.duplicateCountUniversalColumns | default([]) },
    { 'DMF': 'UNIQUE_COUNT',    'COLUMNS': packageConfiguration.uniqueCountUniversalColumns    | default([]) },
    { 'DMF': 'FRESHNESS',       'COLUMNS': packageConfiguration.freshnessUniversalColumns      | default([]) }
] %}

{#------ Build Dictionary of CurrentState DMFs -------#}

{% if currentState %}

    {% set nsCurrentDMFVariables = namespace(objectDMFList=[], columnDMFList=[], customColumnDMFList=[]) %}
    {% set fullyQualifiedCurrentViewName = ref_no_link(currentState.node.location.name, currentState.node.name) %}

    {#------ Build Dictionary of All Object Level DMF -------#}

    {% set currentGroupObjectDMF = currentState.config.adddmfsobject.get('items')
                            | map(attribute='system_dmfs_object')
                            | select('defined')
                            | list
                            if currentState.config.addobjectleveldmfs
                            else [] %}

    {% set nsCurrentDMFVariables.objectDMFList = currentGroupObjectDMF + universalObjectDMF | unique | list %}

    {#------ Build Dictionary of All Column Level DMF -------#}

    {% set items = currentState.config.adddmfs.get('items') or [] %}
    {% set columnDMFs = items | map(attribute='system_dmfs') | select('defined') | unique | list %}
    {% set currentGroupColumnDMF = namespace(data=[]) %}

    {% for dmf in columnDMFs %}
        {% set cols = items | selectattr('system_dmfs', 'equalto', dmf)
                            | map(attribute='columnNameExpressions.name')
                            | select('defined')
                            | unique
                            | list %}

        {% if cols %}
            {% set currentGroupColumnDMF.data = currentGroupColumnDMF.data + [{
                'DMF': dmf,
                'COLUMNS': cols
            }] %}
        {% endif %}
    {% endfor %}

    {% set combinedDuplicateColumnDMFs = currentGroupColumnDMF.data + universalCoulmnDMF %}

    {% for dmf in combinedDuplicateColumnDMFs | map(attribute='DMF') | unique %}
        {% set cols = combinedDuplicateColumnDMFs
                        | selectattr('DMF', 'equalto', dmf)
                        | map(attribute='COLUMNS')
                        | sum(start=[])
                        | unique
                        | list %}

        {% set nsCurrentDMFVariables.columnDMFList = nsCurrentDMFVariables.columnDMFList + [{
            'DMF': dmf,
            'COLUMNS': cols
        }] %}
    {% endfor %}

    {#------ Build Dictionary of All Custom Column Level DMF -------#}

    {% if currentState.config.addCustomDMFs %}
        {% for item in currentState.config.customDMFsConfig.get('items') %}

            {% set args = namespace(elements=[], current=None) %}

            {% for line in item.customDMFArgs.split('\n') %}
                {% set l = line.strip() %}

                {% if l.startswith('- object:') %}
                    {% if args.current %}
                        {% set args.elements = args.elements + [args.current] %}
                    {% endif %}

                    {% set obj = l.replace('- object:', '').replace('"', '').strip() %}
                    {% set args.current = {
                        'object': obj,
                        'cols': []
                    } %}
                {% endif %}

                {% if l.startswith('- col:') and args.current %}
                    {% set col = l.replace('- col:', '').replace('"', '').strip() %}
                    {% set args.current = {
                        'object': args.current.object,
                        'cols': args.current.cols + [col]
                    } %}
                {% endif %}
            {% endfor %}

            {% if args.current %}
                {% set args.elements = args.elements + [args.current] %}
            {% endif %}

            {% set nsCurrentDMFVariables.customColumnDMFList = nsCurrentDMFVariables.customColumnDMFList + [{
                'DMF': item.customDMFName.replace('<', '').replace('>', ''),
                'COLUMNS': args.elements
            }] %}

        {% endfor %}
    {% endif %}
{% endif %}

{% if desiredState %}

    {#------ Build Dictionary of DesiredState DMFs -------#}

    {% set nsDesiredDMFVariables = namespace(objectDMFList=[], columnDMFList=[], customColumnDMFList=[]) %}
    {% set fullyQualifiedDesiredViewName = ref_no_link(desiredState.node.location.name, desiredState.node.name) %}

    {#------ Build Dictionary of All Object Level DMF -------#}

    {% set desiredGroupObjectDMF = desiredState.config.adddmfsobject.get('items')
                            | map(attribute='system_dmfs_object')
                            | select('defined')
                            | list
                            if desiredState.config.addobjectleveldmfs
                            else [] %}

    {% set nsDesiredDMFVariables.objectDMFList = (desiredGroupObjectDMF + universalObjectDMF) | unique | list %}

    {% set items = desiredState.config.adddmfs.get('items') or [] %}
    {% set columnDMFs = items | map(attribute='system_dmfs') | select('defined') | unique | list %}
    {% set desiredGroupColumnDMF = namespace(data=[]) %}

    {% for dmf in columnDMFs %}
        {% set cols = items | selectattr('system_dmfs', 'equalto', dmf)
                            | map(attribute='columnNameExpressions.name')
                            | select('defined')
                            | unique
                            | list %}

        {% if cols %}
            {% set desiredGroupColumnDMF.data = desiredGroupColumnDMF.data + [{
                'DMF': dmf,
                'COLUMNS': cols
            }] %}
        {% endif %}
    {% endfor %}

    {% set combinedDuplicateColumnDMFs = desiredGroupColumnDMF.data + universalCoulmnDMF %}

    {% for dmf in combinedDuplicateColumnDMFs | map(attribute='DMF') | unique %}
        {% set cols = combinedDuplicateColumnDMFs
                        | selectattr('DMF', 'equalto', dmf)
                        | map(attribute='COLUMNS')
                        | sum(start=[])
                        | unique
                        | list %}

        {% set nsDesiredDMFVariables.columnDMFList = nsDesiredDMFVariables.columnDMFList + [{
            'DMF': dmf,
            'COLUMNS': cols
        }] %}
    {% endfor %}

    {#------ Build Dictionary of All Custom Column Level DMF -------#}

    {% if desiredState.config.addCustomDMFs%}
        {% for item in desiredState.config.customDMFsConfig.get('items') %}

            {% set args = namespace(elements=[], current=None) %}

            {% for line in item.customDMFArgs.split('\n') %}
                {% set l = line.strip() %}

                {% if l.startswith('- object:') %}
                    {% if args.current %}
                        {% set args.elements = args.elements + [args.current] %}
                    {% endif %}

                    {% set obj = l.replace('- object:', '').replace('"', '').strip() %}
                    {% set args.current = {
                        'object': obj,
                        'cols': []
                    } %}
                {% endif %}

                {% if l.startswith('- col:') and args.current %}
                    {% set col = l.replace('- col:', '').replace('"', '').strip() %}
                    {% set args.current = {
                        'object': args.current.object,
                        'cols': args.current.cols + [col]
                    } %}
                {% endif %}
            {% endfor %}

            {% if args.current %}
                {% set args.elements = args.elements + [args.current] %}
            {% endif %}

            {% set nsDesiredDMFVariables.customColumnDMFList = nsDesiredDMFVariables.customColumnDMFList + [{
                'DMF': item.customDMFName.replace('<', '').replace('>', ''),
                'COLUMNS': args.elements
            }] %}

        {% endfor %}
    {% endif %}

    {#------------------------------------------------------------#}

	{% if currentState == undefined %}

        {%- for dep in desiredState.sources[0].dependencies -%}

            {% set fullyQualifiedBaseTableName = ref_raw(dep.node.location.name, dep.node.name) %}
            {{ stage('Add DMFs Schedule') }}     
            ALTER TABLE {{ref_raw(dep.node.location.name, dep.node.name)}} 
            {% if desiredState.config.schedulePeriodOption == 'Minutes' %}
                SET DATA_METRIC_SCHEDULE = '{{desiredState.config.schedulePeriod}} Minutes'
            {% elif desiredState.config.schedulePeriodOption == 'CRON'%}
                SET DATA_METRIC_SCHEDULE = 'USING CRON {{desiredState.config.scheduleCRON}}'
            {% elif desiredState.config.schedulePeriodOption == 'TRIGGER_ON_CHANGES'%}
                SET DATA_METRIC_SCHEDULE = 'TRIGGER_ON_CHANGES'
            {% endif%}

            {# ----- Apply Object Level DMFs -------------------#}
            {% for r in nsDesiredDMFVariables.objectDMFList if nsDesiredDMFVariables.objectDMFList %}
                {{ stage('Add Object DMF - ' + r) }}
                ALTER TABLE {{fullyQualifiedBaseTableName }}
                ADD DATA METRIC FUNCTION SNOWFLAKE.CORE.{{ r }}
                ON ()
            {% endfor %}

            {# ----- Apply Column Level DMFs -------------------#}
            {% set tableColumns = desiredState.columns | map(attribute='name') | list %}
    
            {% for dmf in nsDesiredDMFVariables.columnDMFList | sort(attribute='DMF') %}
                {% set cols = dmf.COLUMNS | default([]) | sort %}
                {% if cols is defined and cols | length > 0 %}
                    {% for col in cols %}
                        {% if col in tableColumns %}
                            {{ stage('Add Column DMF - ' + dmf.DMF + '|' + col) }}
                            ALTER TABLE {{ fullyQualifiedBaseTableName }}
                            ADD DATA METRIC FUNCTION SNOWFLAKE.CORE.{{ dmf.DMF }}
                            ON ({{ col }})
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}

            {# ----- Apply Custom Column Level DMFs -------------------#}
            {% if desiredState.config.addCustomDMFs%}

                {% for dmf in nsDesiredDMFVariables.customColumnDMFList %}
                    {{ stage('Add Custom DMF - ' + dmf.DMF.split("'")[3]) }}
                    {% set fullyQualifiedFunctionName = ref_no_quotes(dmf.DMF) %}
                    ALTER TABLE {{ fullyQualifiedBaseTableName }}
                    ADD DATA METRIC FUNCTION {{ fullyQualifiedFunctionName }}
                    ON {{ renderCustomDMFArgs(dmf.COLUMNS) }}
                {% endfor %}

            {% endif %}

            {# ----- Create Data Quality Result View -------------------#}

            {% set sourceDatabase = desiredState.storageLocations
                                    | selectattr('name', 'equalto', dep.node.location.name)
                                    | map(attribute='database')
                                    | first %}
            {% set sourceSchema = desiredState.storageLocations
                                    | selectattr('name', 'equalto', dep.node.location.name)
                                    | map(attribute='schema')
                                    | first %}

            {{ stage('Create Data Quality Result View', true, "sql", "create") }}  
            CREATE OR REPLACE VIEW {{ fullyQualifiedDesiredViewName }} AS
            SELECT SCHEDULED_TIME, MEASUREMENT_TIME, TABLE_DATABASE, TABLE_SCHEMA, TABLE_NAME, METRIC_NAME, ARGUMENT_TYPES, ARGUMENT_NAMES, VALUE
            FROM snowflake.local.data_quality_monitoring_results
            where TABLE_DATABASE = '{{sourceDatabase}}'
            and TABLE_SCHEMA = '{{sourceSchema}}'
            and TABLE_NAME = '{{dep.node.name}}'

            {# Create Email Alter If Enabled #}
            {% if desiredState.config.emailAlertToggle %}

                {% set emailAttributes = namespace(
                    notfIntegrationName='',
                    emailList='',
                    emailSubject='',
                    emailBody='',
                    alertWarehouse='',
                    alertFrequency='',
                    metricCondition=[]
                ) %}

                {{ buildEmailSettings(emailAttributes, fullyQualifiedBaseTableName, fullyQualifiedDesiredViewName) }}

                {% if emailAttributes.metricCondition | trim | length > 0 %}

                    {% set alertName = desiredState.node.name + '_ALERT' %}
                    {% set fullyQualifiedAlertName = ref_no_link(desiredState.node.location.name, alertName) %}

                    {{ stage('Create Data Quality Email Alert') }}
                    CREATE OR REPLACE ALERT {{ fullyQualifiedAlertName }}
                    WAREHOUSE = {{ emailAttributes.alertWarehouse }}
                    SCHEDULE = '{{ emailAttributes.alertFrequency }}'
                    IF
                    (
                        EXISTS
                        (
                            SELECT 1
                            FROM SNOWFLAKE.LOCAL.DATA_QUALITY_MONITORING_RESULTS
                            WHERE TABLE_DATABASE = '{{ sourceDatabase }}'
                            AND TABLE_SCHEMA = '{{ sourceSchema }}'
                            AND TABLE_NAME = '{{ dep.node.name }}'
                            AND measurement_time > COALESCE
                            (
                                    SNOWFLAKE.ALERT.LAST_SUCCESSFUL_SCHEDULED_TIME(),
                                    DATEADD('hour', -24, CURRENT_TIMESTAMP())
                            )
                            AND (
                                {{ emailAttributes.metricCondition | join('\n OR') }}
                            )
                        )
                    )
                    THEN
                    CALL SYSTEM$SEND_EMAIL(
                        '{{ emailAttributes.notfIntegrationName }}',
                        '{{ emailAttributes.emailList }}',
                        '{{ emailAttributes.emailSubject }}',
                        $${{ emailAttributes.emailBody }}$$
                    )

                    {{ stage('Resume Data Quality Email Alert') }}
                    ALTER ALERT {{ fullyQualifiedAlertName }} RESUME
                {% endif %}
            {% endif %}
        {%endfor%}

    {% elif currentState != undefined and desiredState != currentState %}

        {%- for dep in desiredState.sources[0].dependencies -%}
            {% set fullyQualifiedBaseTableName = ref_raw(dep.node.location.name, dep.node.name) %}

            {% if currentState.config.schedulePeriodOption != desiredState.config.schedulePeriodOption %}
                {{ stage('Alter DMFs Schedule') }}
                ALTER TABLE {{ref_raw(dep.node.location.name, dep.node.name)}} 
                {% if desiredState.config.schedulePeriodOption == 'Minutes' %}
                    SET DATA_METRIC_SCHEDULE = '{{desiredState.config.schedulePeriod}} Minutes'
                {% elif desiredState.config.schedulePeriodOption == 'CRON'%}
                    SET DATA_METRIC_SCHEDULE = 'USING CRON {{desiredState.config.scheduleCRON}}'
                {% elif desiredState.config.schedulePeriodOption == 'TRIGGER_ON_CHANGES'%}
                    SET DATA_METRIC_SCHEDULE = 'TRIGGER_ON_CHANGES'
                {% endif%}
            {% endif%}

            {# ----------------------- Object DMF Functions ----------------------- #}
            {% if desiredState.config.addobjectleveldmfs or (desiredState.config.addobjectleveldmfs == false and currentState.config.addobjectleveldmfs) %}

                {% for dmf in desiredGroupObjectDMF %}
                    {% if dmf not in currentGroupObjectDMF or (desiredState.config.addobjectleveldmfs and currentState.config.addobjectleveldmfs == false) %}
                        {{ stage('Add Object DMF - ' + dmf) }}
                        ALTER TABLE {{ref_raw(dep.node.location.name, dep.node.name)}} 
                        ADD DATA METRIC FUNCTION SNOWFLAKE.CORE.{{ dmf }}
                        ON  ()
                    {% endif %}
                {% endfor %}

                {% for dmf in currentGroupObjectDMF %}
                    {% if dmf not in desiredGroupObjectDMF or (desiredState.config.addobjectleveldmfs == false and currentState.config.addobjectleveldmfs) %}
                        {{ stage('Drop Object DMF - ' + dmf) }}
                        ALTER TABLE {{ref_raw(dep.node.location.name, dep.node.name)}} 
                        DROP DATA METRIC FUNCTION SNOWFLAKE.CORE.{{ dmf }}
                        ON  ()
                    {% endif %}
                {% endfor %}
            {% endif %}

            {# ----------------------- Column DMF Functions ----------------------- #}
            {% if desiredState.config.addcolumnleveldmfs or (desiredState.config.addcolumnleveldmfs == false and currentState.config.addcolumnleveldmfs) %}

                {% set nsColKeyList = namespace(desired=[], current=[]) %}
                {% for dmf in desiredGroupColumnDMF.data %}
                    {% for col in dmf.COLUMNS %}
                        {% set nsColKeyList.desired = nsColKeyList.desired + [dmf.DMF ~ '|' ~ col] %}
                    {% endfor %}
                {% endfor %}

                {% for dmf in currentGroupColumnDMF.data %}
                    {% for col in dmf.COLUMNS %}
                        {% set nsColKeyList.current = nsColKeyList.current + [dmf.DMF ~ '|' ~ col] %}
                    {% endfor %}
                {% endfor %}

                {% for dmf in desiredGroupColumnDMF.data %}
                    {% for col in dmf.COLUMNS %}
                        {% set key = dmf.DMF ~ '|' ~ col %}
                        {% if key not in nsColKeyList.current or (desiredState.config.addcolumnleveldmfs and currentState.config.addcolumnleveldmfs == false) %}
                            {{ stage('Add Column DMF - ' ~ dmf.DMF ~ '|' ~ col) }}

                            ALTER TABLE {{ ref_raw(dep.node.location.name, dep.node.name) }}
                            ADD DATA METRIC FUNCTION SNOWFLAKE.CORE.{{ dmf.DMF }}
                            ON ({{ col }})
                        {% endif %}
                    {% endfor %}
                {% endfor %}

                {% for dmf in currentGroupColumnDMF.data %}
                    {% for col in dmf.COLUMNS %}
                        {% set key = dmf.DMF ~ '|' ~ col %}
                        {% if key not in nsColKeyList.desired or (desiredState.config.addcolumnleveldmfs == false and currentState.config.addcolumnleveldmfs) %}
                            {{ stage('Drop Column DMF - ' ~ dmf.DMF ~ '|' ~ col) }}

                            ALTER TABLE {{ ref_raw(dep.node.location.name, dep.node.name) }}
                            DROP DATA METRIC FUNCTION SNOWFLAKE.CORE.{{ dmf.DMF }}
                            ON ({{ col }})
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}

            {# ----------------------- Custom DMF Functions ----------------------- #}
            {% if desiredState.config.addCustomDMFs or (desiredState.config.addCustomDMFs == false and currentState.config.addCustomDMFs) %}

                {% set nsCustColKeyList = namespace(desired=[], current=[]) %}

                {% for dmf in nsCurrentDMFVariables.customColumnDMFList %}
                    {% set key = dmf.DMF ~ '|' ~ renderCustomDMFArgs(dmf.COLUMNS) %}
                    {% set nsCustColKeyList.current = nsCustColKeyList.current + [key] %}
                {% endfor %}

                {% for dmf in nsDesiredDMFVariables.customColumnDMFList %}
                    {% set key = dmf.DMF ~ '|' ~ renderCustomDMFArgs(dmf.COLUMNS) %}
                    {% set nsCustColKeyList.desired = nsCustColKeyList.desired + [key] %}
                {% endfor %}

                {% for dmf in nsDesiredDMFVariables.customColumnDMFList %}
                    {% set key = dmf.DMF ~ '|' ~ renderCustomDMFArgs(dmf.COLUMNS) %}

                    {% if key not in nsCustColKeyList.current or (desiredState.config.addCustomDMFs and currentState.config.addCustomDMFs == false) %}
                        {{ stage('Add Custom DMF - ' ~ dmf.DMF.split("'")[3]) }}

                        {% set fullyQualifiedFunctionName = ref_no_quotes(dmf.DMF) %}

                        ALTER TABLE {{ fullyQualifiedBaseTableName }}
                        ADD DATA METRIC FUNCTION {{ fullyQualifiedFunctionName }}
                        ON {{ renderCustomDMFArgs(dmf.COLUMNS) }}

                    {% endif %}
                {% endfor %}

                {% for dmf in nsCurrentDMFVariables.customColumnDMFList %}
                    {% set key = dmf.DMF ~ '|' ~ renderCustomDMFArgs(dmf.COLUMNS) %}

                    {% if key not in nsCustColKeyList.desired or (desiredState.config.addCustomDMFs == false and currentState.config.addCustomDMFs) %}
                        {{ stage('Drop Custom DMF - ' ~ dmf.DMF.split("'")[3]) }}

                        {% set fullyQualifiedFunctionName = ref_no_quotes(dmf.DMF) %}

                        ALTER TABLE {{ fullyQualifiedBaseTableName }}
                        DROP DATA METRIC FUNCTION {{ fullyQualifiedFunctionName }}
                        ON {{ renderCustomDMFArgs(dmf.COLUMNS) }}

                    {% endif %}
                {% endfor %}
            {% endif %}

            {% set sourceDatabase = desiredState.storageLocations | selectattr('name', 'equalto', dep.node.location.name) | map(attribute='database') | first %}
            {% set sourceSchema = desiredState.storageLocations | selectattr('name', 'equalto', dep.node.location.name) | map(attribute='schema') | first %}

            {{ stage('Create Data Quality Result View', true, "sql", "create") }}
            CREATE OR REPLACE VIEW {{ fullyQualifiedDesiredViewName }} AS
            SELECT SCHEDULED_TIME, MEASUREMENT_TIME, TABLE_DATABASE,TABLE_SCHEMA,TABLE_NAME,METRIC_NAME,ARGUMENT_TYPES,ARGUMENT_NAMES,VALUE
            FROM snowflake.local.data_quality_monitoring_results
            where TABLE_DATABASE = '{{sourceDatabase}}'
            and TABLE_SCHEMA = '{{sourceSchema}}'
            and TABLE_NAME = '{{dep.node.name}}'

        {%endfor%}
    {%endif%}

{%elif currentState != undefined and desiredState == undefined %}
    {%- for dep in currentState.sources[0].dependencies -%}

            {% set fullyQualifiedBaseTableName = ref_raw(dep.node.location.name, dep.node.name) %}

            {# ----- Apply Object Level DMFs -------------------#}
            {% for dmf in nsCurrentDMFVariables.objectDMFList if nsCurrentDMFVariables.objectDMFList %}
                {{ stage('Drop Object DMF - ' + dmf) }}
                ALTER TABLE {{ref_raw(dep.node.location.name, dep.node.name)}} 
                DROP DATA METRIC FUNCTION SNOWFLAKE.CORE.{{ dmf }}
                ON ()
            {% endfor %}

            {# ----- Apply Column Level DMFs -------------------#}
            {% set tableColumns = currentState.columns | map(attribute='name') | list %}
    
            {% for dmf in nsCurrentDMFVariables.columnDMFList | sort(attribute='DMF') %}
                {% set cols = dmf.COLUMNS | default([]) | sort %}
                {% if cols is defined and cols | length > 0 %}
                    {% for col in cols %}
                        {% if col in tableColumns %}
                            {{ stage('Drop Column DMF - ' + dmf.DMF + '|' + col) }}
                            ALTER TABLE {{ fullyQualifiedBaseTableName }}
                            DROP DATA METRIC FUNCTION SNOWFLAKE.CORE.{{ dmf.DMF }}
                            ON ({{ col }})
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}

            {# ----- Apply Custom Column Level DMFs -------------------#}
            {% if currentState.config.addCustomDMFs %}
                {% for dmf in nsCurrentDMFVariables.customColumnDMFList %}
                    {{ stage('Add Custom DMF - ' + dmf.DMF.split("'")[3]) }}
                    {% set fullyQualifiedFunctionName = ref_no_quotes(dmf.DMF) %}
                    ALTER TABLE {{ fullyQualifiedBaseTableName }}
                    DROP DATA METRIC FUNCTION {{ fullyQualifiedFunctionName }} 
                    ON {{ renderCustomDMFArgs(dmf.COLUMNS) }}
                {% endfor %}
            {% endif %}

        {{ stage('Unset DMFs Schedule') }}
        ALTER TABLE {{ref_raw(dep.node.location.name, dep.node.name)}} 
        UNSET DATA_METRIC_SCHEDULE

        {{ stage('Drop Data Quality Result View', true, "sql", "create") }}  
        DROP VIEW IF EXISTS {{ fullyQualifiedCurrentViewName }}

        {# Drop Email Alert #}
        {% if currentState.config.emailAlertToggle %}
            {% set alertName = currentState.node.name + '_ALERT' %}
            {% set fullyQualifiedAlertName = ref_no_link(currentState.node.location.name, alertName) %}

            {{ stage('Drop Data Quality Email Alert') }}
            DROP ALERT IF EXISTS {{ fullyQualifiedAlertName }}
        {% endif %}

    {%endfor%}
{%endif%}